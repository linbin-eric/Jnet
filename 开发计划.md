# 目标

1. 删除HttpRequestDecoder。
2. 新开发一个AggregationHttpReqDecoder,收到完整的 HttpReq 后，组装为 HttpRequest 传递到后面的处理器。

## 核心思路

1. 删除 `HttpRequestDecoder` 类，该类直接从字节流解码完整的 HTTP 请求，但不支持 chunked 编码。
2. 新建 `AggregationHttpReqDecoder` 类，作为 `HttpReqPartDecoder` 的下游处理器：
   - 接收 `HttpReqHead`：保存请求头信息
   - 接收 `HttpReqBodyPart`：累积请求体数据
   - 接收 `HttpReqEnd`：组装完整的 `HttpRequest` 并传递给下游
3. 修改 `HttpRequest` 类，删除 `wholeRequest` 相关字段和逻辑。
4. 更新所有使用 `HttpRequestDecoder` 的地方，改为使用 `HttpReqPartDecoder` + `AggregationHttpReqDecoder` 组合。

## 详细实现思路

### AggregationHttpReqDecoder 设计

- 继承 `ReadProcessor<HttpReq>` 接口，处理 `HttpReq` 类型的消息
- 内部状态：
  - `HttpReqHead head`：暂存请求头
  - `IoBuffer body`：累积请求体数据
- 处理逻辑：
  - 收到 `HttpReqHead`：保存到 `head` 字段
  - 收到 `HttpReqBodyPart`：将 `part` 累积到 `body`
  - 收到 `HttpReqEnd`：组装 `HttpRequest`，传递给下游，重置状态
  - 组装时从 `headers` 中解析 `Content-Type` 并设置到 `HttpRequest.contentType`

### HttpRequest 修改

- 删除 `wholeRequest` 字段
- 删除 `lineLength`、`headerLength`、`bodyLength` 字段（这些依赖于原始字节流位置）
- 修改 `close()` 方法，移除 `wholeRequest` 相关代码

## 实施步骤

### 步骤1：修改 HttpRequest 类

文件：`src/main/java/cc/jfire/jnet/extend/http/dto/HttpRequest.java`

删除以下字段：
```java
protected IoBuffer            wholeRequest;
protected int                 lineLength;
protected int                 headerLength;
protected int                 bodyLength;
```

修改 `close()` 方法为：
```java
public void close()
{
    if (body != null)
    {
        body.free();
        body = null;
    }
}
```

### 步骤2：新建 AggregationHttpReqDecoder 类

文件：`src/main/java/cc/jfire/jnet/extend/http/coder/AggregationHttpReqDecoder.java`

```java
package cc.jfire.jnet.extend.http.coder;

import cc.jfire.jnet.common.api.ReadProcessor;
import cc.jfire.jnet.common.api.ReadProcessorNode;
import cc.jfire.jnet.common.buffer.buffer.IoBuffer;
import cc.jfire.jnet.common.util.HttpDecodeUtil;
import cc.jfire.jnet.extend.http.dto.*;

public class AggregationHttpReqDecoder implements ReadProcessor<HttpReq>
{
    private HttpReqHead head;
    private IoBuffer    body;

    @Override
    public void read(HttpReq data, ReadProcessorNode next)
    {
        if (data instanceof HttpReqHead)
        {
            head = (HttpReqHead) data;
        }
        else if (data instanceof HttpReqBodyPart)
        {
            HttpReqBodyPart part = (HttpReqBodyPart) data;
            if (body == null)
            {
                body = part.getPart();
            }
            else
            {
                body.put(part.getPart());
                part.getPart().free();
            }
        }
        else if (data instanceof HttpReqEnd)
        {
            HttpRequest request = new HttpRequest();
            request.setMethod(head.getMethod());
            request.setUrl(head.getUrl());
            request.setVersion(head.getVersion());
            request.setHeaders(head.getHeaders());
            request.setContentLength(head.getContentLength());
            HttpDecodeUtil.findContentType(head.getHeaders(), request::setContentType);
            request.setBody(body);
            next.fireRead(request);
            head = null;
            body = null;
        }
    }

    @Override
    public void readFailed(Throwable e, ReadProcessorNode next)
    {
        if (body != null)
        {
            body.free();
            body = null;
        }
        head = null;
        next.fireReadFailed(e);
    }
}
```

### 步骤3：删除 HttpRequestDecoder 类

删除文件：`src/main/java/cc/jfire/jnet/extend/http/coder/HttpRequestDecoder.java`

### 步骤4：更新 SampleHttpServer

文件：`src/test/java/cc/jfire/jnet/SampleHttpServer.java`

将：
```java
pipeline.addReadProcessor(new HttpRequestDecoder());
```
改为：
```java
pipeline.addReadProcessor(new HttpReqPartDecoder());
pipeline.addReadProcessor(new AggregationHttpReqDecoder());
```

### 步骤5：更新 ReverseProxyServer

文件：`src/main/java/cc/jfire/jnet/extend/reverse/proxy/ReverseProxyServer.java`

将两处：
```java
pipeline.addReadProcessor(new HttpRequestDecoder());
```
改为：
```java
pipeline.addReadProcessor(new HttpReqPartDecoder());
pipeline.addReadProcessor(new AggregationHttpReqDecoder());
```

### 步骤6：更新 README.md

文件：`README.md`

将示例代码中的：
```java
pipeline.addReadProcessor(new HttpRequestDecoder());
```
改为：
```java
pipeline.addReadProcessor(new HttpReqPartDecoder());
pipeline.addReadProcessor(new AggregationHttpReqDecoder());
```

将组件表格中的：
```md
| `HttpRequestDecoder` | HTTP 请求解码器 |
```
删除，并新增：
```md
| `HttpReqPartDecoder` | HTTP 分段解码器（支持 chunked） |
| `AggregationHttpReqDecoder` | HTTP 请求聚合器（组装 HttpRequest） |
```

## 待办列表

1. 修改 HttpRequest 类，删除 wholeRequest 等字段
2. 新建 AggregationHttpReqDecoder 类
3. 删除 HttpRequestDecoder 类
4. 更新 SampleHttpServer 使用新的解码器组合
5. 更新 ReverseProxyServer 使用新的解码器组合
6. 更新 README.md 文档

## 需要修改或新增的类

| 类名 | 操作 |
|------|------|
| `HttpRequest` | 修改 |
| `AggregationHttpReqDecoder` | 新增 |
| `HttpRequestDecoder` | 删除 |
| `SampleHttpServer` | 修改 |
| `ReverseProxyServer` | 修改 |
