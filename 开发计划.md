# 目标

1. 新增了类：HttpRequestChunkedBodyPart，需要修改cc.jfire.jnet.extend.http.coder.HttpRequestPartDecoder 中对应的解析方法，返回这个类型。

## 核心思路

在 HTTP 分块传输编码（chunked transfer encoding）中，每个chunk由以下部分组成：
1. chunk size行：16进制数字 + CRLF（\r\n）
2. chunk data：实际的数据内容
3. CRLF：数据结束标志

当前 `HttpRequestPartDecoder.parseBodyChunked` 方法已经能够正确解析chunk，但在第211行创建的part对象类型错误，应该使用新增的 `HttpRequestChunkedBodyPart` 替代 `HttpRequestFixLengthBodyPart`，并且需要正确设置该对象的三个字段：
- `headLength`: chunk size行的长度（包括CRLF）
- `chunkLength`: 整个chunk的长度（包括chunk size行、数据内容、结尾的CRLF）
- `part`: 完整的chunk内容（从chunk size行开始到结尾CRLF）

## 详细实现思路

1. **保留chunk头部信息**：在解析chunk size时（176-190行），需要记录chunk size行在buffer中的起始位置和长度，以便后续设置到HttpRequestChunkedBodyPart对象中。

2. **修改part创建逻辑**：在207-216行的chunk数据读取部分，将创建的 `HttpRequestFixLengthBodyPart` 改为 `HttpRequestChunkedBodyPart`，并设置其三个字段：
   - `headLength`: chunk size行的字节长度（从size起始到CRLF结束）
   - `chunkLength`: headLength + chunkSize（数据内容） + 2（结尾CRLF）
   - `part`: 从chunk size行起始位置截取chunkLength长度的buffer

3. **新增成员变量**：需要在HttpRequestPartDecoder类中新增一个成员变量 `chunkSizeLineLength`，用于记录chunk size行的长度。

## 实施步骤

### 步骤1: 在HttpRequestPartDecoder类中新增成员变量

在第19行 `chunkSize` 变量声明后，新增成员变量：
```java
private int chunkSizeLineLength = -1;
```

### 步骤2: 在parseBodyChunked方法中记录chunk size行长度

修改176-190行的chunk size解析逻辑，在成功解析chunk size后记录chunk size行的长度，但不立即移动readPosi：

```java
if (chunkSize == -1)
{
    int startPosi = accumulation.getReadPosi();
    for (int i = startPosi; i < accumulation.getWritePosi() - 1; i++)
    {
        if (i - startPosi > MAX_CHUNK_SIZE_LINE_LENGTH)
        {
            throw new IllegalStateException("Chunk size line exceeds " + MAX_CHUNK_SIZE_LINE_LENGTH + " bytes");
        }
        if (accumulation.get(i) == '\r' && accumulation.get(i + 1) == '\n')
        {
            chunkSize = Integer.parseInt(StandardCharsets.US_ASCII.decode(accumulation.readableByteBuffer(i)).toString().trim(), 16);
            chunkSizeLineLength = i + 2 - startPosi; // 记录chunk size行的长度（包含CRLF）
            // 注意：这里不移动readPosi，保持在chunk size行的起始位置
            break;
        }
    }
}
```

### 步骤3: 修改chunk数据读取部分的part创建逻辑

将196-216行的逻辑修改为：

```java
// 处理chunk size为0的情况（结束标志）
if (chunkSize == 0)
{
    // chunk size为0时，格式为：0\r\n\r\n（chunk size行 + 结尾的CRLF）
    int totalLength = chunkSizeLineLength + 2;
    if (accumulation.remainRead() < totalLength)
    {
        return false;
    }
    // 跳过整个结束chunk
    accumulation.addReadPosi(totalLength);
    next.fireRead(new HttpRequestPartEnd());
    resetState();
    return accumulation != null && accumulation.remainRead() > 0;
}

// 检查是否已接收完整的chunk（chunk size行 + chunk数据 + 结尾CRLF）
int totalChunkLength = chunkSizeLineLength + chunkSize + 2;
if (accumulation.remainRead() < totalChunkLength)
{
    return false;
}

// 创建HttpRequestChunkedBodyPart对象
HttpRequestChunkedBodyPart part = new HttpRequestChunkedBodyPart();
part.setHeadLength(chunkSizeLineLength);
part.setChunkLength(totalChunkLength);
// 从当前读取位置（chunk size行起始）截取完整的chunk内容
part.setPart(accumulation.slice(totalChunkLength));

next.fireRead(part);
chunkSize = -1;
chunkSizeLineLength = -1; // 重置chunk size行长度
return true;
```

### 步骤4: 在resetState方法中重置chunkSizeLineLength

在219-230行的resetState方法中，添加对chunkSizeLineLength的重置：

```java
private void resetState()
{
    reqHead   = null;
    bodyRead  = 0;
    chunkSize = -1;
    chunkSizeLineLength = -1; // 新增：重置chunk size行长度
    state     = ParseState.REQUEST_LINE;
    if (accumulation != null && accumulation.remainRead() == 0)
    {
        accumulation.free();
        accumulation = null;
    }
}
```

### 步骤5: 添加必要的import语句

在文件顶部的import区域，添加：
```java
import cc.jfire.jnet.extend.http.dto.HttpRequestChunkedBodyPart;
```

### 步骤6: 为HttpRequestChunkedBodyPart类添加getter和setter方法

在HttpRequestChunkedBodyPart类中添加Lombok的@Data注解或手动添加getter/setter方法：
```java
package cc.jfire.jnet.extend.http.dto;

import cc.jfire.jnet.common.buffer.buffer.IoBuffer;
import lombok.Data;

@Data
public class HttpRequestChunkedBodyPart implements HttpRequestPart
{
    /**
     * chunk 的头部长度，含 CRLF
     */
    private int      headLength;
    /**
     * chunk 的长度，含 CRLF
     */
    private int      chunkLength;
    /**
     * 完整的内容，包含头部，内容，CRLF
     */
    private IoBuffer part;
}
```

## 待办列表

1. 在HttpRequestPartDecoder类中新增chunkSizeLineLength成员变量
2. 修改parseBodyChunked方法中的chunk size解析逻辑，记录chunk size行长度
3. 修改parseBodyChunked方法中的chunk数据读取逻辑，创建HttpRequestChunkedBodyPart对象并正确设置字段
4. 在resetState方法中添加chunkSizeLineLength的重置逻辑
5. 在HttpRequestPartDecoder类中添加HttpRequestChunkedBodyPart的import语句
6. 为HttpRequestChunkedBodyPart类添加@Data注解

## 需要修改或新增的类

1. **HttpRequestChunkedBodyPart**（新增）：需要添加@Data注解或getter/setter方法
2. **HttpRequestPartDecoder**（修改）：
   - 新增成员变量 `chunkSizeLineLength`
   - 修改 `parseBodyChunked` 方法的chunk size解析和chunk数据读取逻辑
   - 修改 `resetState` 方法
   - 添加import语句