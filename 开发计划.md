# 目标

1. 修改HttpRequest，删除其中的属性，采用 HttpRequestPartHead 和HttpRequestFixLengthBodyPart 来代替。但是要保留原本的方法。这样避免重复的类设计。

# 核心思路

将 `HttpRequest` 重构为组合模式，内部持有 `HttpRequestPartHead` 对象来管理头部信息，同时保留 `body` 和 `strBody` 作为独立属性。通过委托方式保留原有的公开方法，确保外部调用者无感知。

**为什么不使用 HttpRequestFixLengthBodyPart：**
- `HttpRequestFixLengthBodyPart` 内部只有 `IoBuffer part` 属性，用它包装 `body` 是多余的封装
- `body` 和 `strBody` 直接作为 `HttpRequest` 属性更简洁
- `HttpRequestFixLengthBodyPart` 保留用于流式传输场景（分片传输）

**属性处理策略：**
1. **url 属性**：删除，但保留 `setUrl` 方法，内部委托给 `HttpRequestPartHead.setUrl()`
2. **body 和 strBody 属性**：保留，作为 `HttpRequest` 独立属性，以 `body` 为优先
3. **contentType 属性**：删除，但保留 `setContentType` 方法，内部直接设置 header

# 详细实现思路

## 1. HttpRequest 类重构

**新增属性：**
- `HttpRequestPartHead head`：持有请求头部信息

**保留属性：**
- `IoBuffer body`：二进制请求体
- `String strBody`：字符串形式的请求体

**删除属性：**
- `url`、`domain`、`port`、`method`、`path`、`version`、`headers`、`contentLength`、`contentType`

**方法委托实现：**
- `getDomain()` → `head.getDomain()`
- `setDomain(String)` → `head.setDomain(String)`
- `getPort()` → `head.getPort()`
- `setPort(int)` → `head.setPort(int)`
- `getMethod()` → `head.getMethod()`
- `setMethod(String)` → `head.setMethod(String)`
- `getPath()` → `head.getPath()`
- `setPath(String)` → `head.setPath(String)`
- `getVersion()` → `head.getVersion()`
- `setVersion(String)` → `head.setVersion(String)`
- `getHeaders()` → `head.getHeaders()`
- `setHeaders(Map)` → `head.setHeaders(Map)`
- `getContentLength()` → `head.getContentLength()`
- `setContentLength(long)` → `head.setContentLength(long)`
- `addHeader(String, String)` → `head.addHeader(String, String)`
- `setUrl(String)` → `head.setUrl(String)`
- `setContentType(String)` → `head.addHeader("Content-Type", value)`

## 2. HttpRequestAggregator 修改

聚合逻辑需要调整，直接将 `HttpRequestPartHead` 设置到 `HttpRequest` 中，body 直接赋值给 `HttpRequest.body`。

## 3. HttpRequestPartEncoder 修改

编码 `HttpRequest` 时，需要适配新的结构：
- 从 `head` 获取请求行和 headers 信息
- 从 `bodyPart` 或 `strBody` 获取请求体

# 实施步骤

## 步骤1：修改 HttpRequest 类结构

删除原有属性，新增 head 组合属性，保留 body 和 strBody：

```java
@Data
@ToString(exclude = "body")
public class HttpRequest implements AutoCloseable
{
    protected HttpRequestPartHead head = new HttpRequestPartHead();
    protected IoBuffer            body;
    protected String              strBody;

    // 委托方法 - 详见详细实现思路

    public void close()
    {
        head.close();
        if (body != null)
        {
            body.free();
            body = null;
        }
    }
}
```

## 步骤2：修改 HttpRequestAggregator 类

修改 `fireAggregatedRequest` 方法，直接设置 head 和 body：

```java
private void fireAggregatedRequest(ReadProcessorNode next)
{
    HttpRequest request = new HttpRequest();
    request.setHead(head);
    request.setBody(body);
    if (head.isChunked())
    {
        head.setContentLength(body == null ? 0 : body.remainRead());
    }
    next.fireRead(request);
    head = null;
    body = null;
}
```

## 步骤3：修改 HttpRequestPartEncoder 类

修改 `encodeHttpRequest` 方法，适配新结构，从 `request.getHead()` 获取头部信息，从 `request.getBody()` 或 `request.getStrBody()` 获取请求体。

# 待办列表

1. [ ] 重构 HttpRequest 类：删除原有属性，新增 head 组合属性，保留 body 和 strBody
2. [ ] 实现 HttpRequest 委托方法：头部相关 getter/setter 委托到 head
3. [ ] 修改 HttpRequestAggregator：调整聚合逻辑，直接设置 head 和 body
4. [ ] 修改 HttpRequestPartEncoder：适配新的 HttpRequest 结构
5. [ ] 编译验证：执行 mvn compile 确保无编译错误

# 需要修改或新增的类

| 类名 | 操作 | 说明 |
|------|------|------|
| HttpRequest | 修改 | 重构为组合模式，持有 head，保留 body 和 strBody |
| HttpRequestAggregator | 修改 | 调整聚合逻辑 |
| HttpRequestPartEncoder | 修改 | 适配新的 HttpRequest 结构 |